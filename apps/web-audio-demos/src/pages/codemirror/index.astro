<div id="editor-container"></div>

<script>
  import { basicSetup } from "codemirror";
  import { EditorView } from "@codemirror/view";
  import { javascript } from "@codemirror/lang-javascript";
  import { HighlightStyle, syntaxHighlighting } from "@codemirror/language";
  import { tags } from "@lezer/highlight";

  const ALLOW_FOLD = false;

  const editorTheme = EditorView.theme({
    "&": {
      backgroundColor: "var(--color-cm-background)",
      color: "var(--color-cm-text)",
    },
    ".cm-content": {
      caretColor: "var(--color-cm-caret)",
    },
    ".cm-cursor": {
      borderLeftColor: "var(--color-cm-caret)",
    },
    ".cm-gutters": {
      backgroundColor: "var(--color-cm-gutter-bg)",
      color: "var(--color-cm-gutter-fg)",
      borderRight: "1px solid var(--color-cm-gutter-border)",
    },
    ".cm-activeLineGutter": {
      backgroundColor: "var(--color-cm-active-line-gutter-bg)",
      color: "var(--color-cm-active-line-gutter-fg)",
    },
    "& .cm-line": {
      backgroundColor: "var(--color-cm-line-bg)",
      inlineSize: "var(--color-cm-line-inline-size)",
    },
    "& .cm-line.cm-activeLine": {
      backgroundColor: "var(--color-cm-active-line-bg)",
    },
    ".cm-selectionBackground, &.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground":
      {
        backgroundColor: "var(--color-cm-selection-bg)",
      },
    "& .cm-line .cm-matchingBracket, & .cm-line .cm-nonmatchingBracket": {
      outline: "none",
    },
    "& .cm-line .cm-matchingBracket": {
      backgroundColor: "var(--color-cm-matching-bracket-bg)",
    },
    "& .cm-line .cm-matchingBracket > span": {
      color: "var(--color-cm-matching-bracket-fg)",
    },
    "& .cm-line .cm-nonmatchingBracket": {
      backgroundColor: "var(--color-cm-nonmatching-bracket-bg)",
    },
    "& .cm-line .cm-nonmatchingBracket > span": {
      color: "var(--color-cm-nonmatching-bracket-fg)",
    },
    "& .cm-line .cm-selectionMatch": {
      backgroundColor: "var(--color-cm-selection-match-bg)",
    },
    "& .cm-line .cm-selectionMatch > span": {
      color: "var(--color-cm-selection-match-fg)",
    },
    "& .cm-gutters > .cm-gutter.cm-foldGutter": {
      pointerEvents: ALLOW_FOLD ? "auto" : "none",
    },
    "& .cm-gutters > .cm-gutter.cm-foldGutter > .cm-gutterElement > span": {
      visibility: ALLOW_FOLD ? "visible" : "hidden",
    },
  });

  const highlightStyle = HighlightStyle.define([
    { tag: tags.keyword, color: "var(--color-cm-keyword)" },
    { tag: tags.controlKeyword, color: "var(--color-cm-control-keyword)" },
    { tag: tags.operator, color: "var(--color-cm-operator)" },
    { tag: tags.punctuation, color: "var(--color-cm-punctuation)" },
    { tag: tags.string, color: "var(--color-cm-string)" },
    { tag: tags.number, color: "var(--color-cm-number)" },
    { tag: tags.bool, color: "var(--color-cm-bool)" },
    { tag: tags.null, color: "var(--color-cm-null)" },
    { tag: tags.variableName, color: "var(--color-cm-variable)" },
    {
      tag: tags.definition(tags.variableName),
      color: "var(--color-cm-definition)",
    },
    {
      tag: tags.function(tags.variableName),
      color: "var(--color-cm-function)",
    },
    { tag: tags.propertyName, color: "var(--color-cm-property)" },
    {
      tag: tags.comment,
      color: "var(--color-cm-comment)",
      fontStyle: "italic",
    },
    {
      tag: tags.lineComment,
      color: "var(--color-cm-comment)",
      fontStyle: "italic",
    },
    {
      tag: tags.blockComment,
      color: "var(--color-cm-comment)",
      fontStyle: "italic",
    },
    { tag: tags.typeName, color: "var(--color-cm-type)" },
    { tag: tags.className, color: "var(--color-cm-class)" },
    { tag: tags.regexp, color: "var(--color-cm-regexp)" },
  ]);

  const container = document.querySelector("#editor-container") ?? undefined;

  const sampleCode = `// Sample JavaScript code
function greet(name) {
  const message = "Hello, " + name + "!";
  console.log(message);
  return message;
}

const numbers = [1, 2, 3, 4, 5];
const doubled = numbers.map(n => n * 2);

if (doubled.length > 0) {
  greet("World");
}`;

  const view = new EditorView({
    doc: sampleCode,
    parent: container,
    extensions: [
      basicSetup,
      javascript(),
      editorTheme,
      syntaxHighlighting(highlightStyle),
    ],
  });

  window.addEventListener("keydown", (e) => {
    if (e.altKey && e.key === "â€ ") {
      e.preventDefault();
      toggleTheme();
    } else if (e.altKey && e.key === "Enter") {
      e.preventDefault();
      flash(300);
    }
  });

  function toggleTheme() {
    if (!(container instanceof HTMLElement)) return;

    let currentTheme = container.dataset.theme;
    if (!currentTheme) {
      currentTheme = window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light";
    }
    container.dataset.theme = currentTheme === "dark" ? "light" : "dark";
  }

  let timeoutId: ReturnType<typeof setTimeout> | null;

  function flash(dur = 200) {
    if (!(container instanceof HTMLElement)) return;
    if (timeoutId) clearTimeout(timeoutId);

    const cursorPos = view.state.selection.ranges[0].from;
    container.dataset.flash = "true";
    container.inert = true;

    timeoutId = setTimeout(() => {
      container.dataset.flash = "false";
      container.inert = false;
      view.focus();
      view.dispatch({ selection: { anchor: cursorPos, head: cursorPos } });
      timeoutId = null;
    }, dur);
  }
</script>

<style>
  :root {
    /* Color tokens */
    --color-neutral-50-lch: 0.984 0.003 247.86;
    --color-neutral-50: oklch(var(--color-neutral-50-lch));
    --color-neutral-100: oklch(0.968 0.007 247.9);
    --color-neutral-200: oklch(0.929 0.013 255.51);
    --color-neutral-300: oklch(0.869 0.022 252.89);
    --color-neutral-400: oklch(0.704 0.04 256.79);
    --color-neutral-500: oklch(0.554 0.046 257.42);
    --color-neutral-600: oklch(0.446 0.043 257.28);
    --color-neutral-700: oklch(0.372 0.044 257.29);
    --color-neutral-800: oklch(0.279 0.041 260.03);
    --color-neutral-900: oklch(0.208 0.042 265.75);
    --color-neutral-950-lch: 0.129 0.042 264.69;
    --color-neutral-950: oklch(var(--color-neutral-950-lch));
    --color-blue-50: oklch(0.97 0.014 254.6);
    --color-blue-100: oklch(0.932 0.032 255.59);
    --color-blue-200: oklch(0.882 0.059 254.13);
    --color-blue-300: oklch(0.809 0.105 251.81);
    --color-blue-400: oklch(0.707 0.165 254.62);
    --color-blue-500: oklch(0.623 0.214 259.81);
    --color-blue-600: oklch(0.546 0.245 262.88);
    --color-blue-700: oklch(0.488 0.243 264.38);
    --color-blue-800: oklch(0.424 0.199 265.64);
    --color-blue-900: oklch(0.379 0.146 265.52);
    --color-blue-950: oklch(0.282 0.091 267.94);
    --color-green-50: oklch(0.979 0.021 166.11);
    --color-green-100: oklch(0.95 0.052 163.05);
    --color-green-200: oklch(0.905 0.093 164.15);
    --color-green-300: oklch(0.845 0.143 164.98);
    --color-green-400: oklch(0.765 0.177 163.22);
    --color-green-500: oklch(0.696 0.17 162.48);
    --color-green-600: oklch(0.596 0.145 163.22);
    --color-green-700: oklch(0.508 0.118 165.61);
    --color-green-800: oklch(0.432 0.095 166.91);
    --color-green-900: oklch(0.378 0.077 168.94);
    --color-green-950: oklch(0.262 0.051 172.55);
    --color-yellow-50: oklch(0.987 0.026 102.21);
    --color-yellow-100: oklch(0.973 0.071 103.19);
    --color-yellow-200: oklch(0.945 0.129 101.54);
    --color-yellow-300: oklch(0.905 0.182 98.11);
    --color-yellow-400: oklch(0.852 0.199 91.94);
    --color-yellow-500: oklch(0.795 0.184 86.05);
    --color-yellow-600: oklch(0.681 0.162 75.83);
    --color-yellow-700: oklch(0.554 0.135 66.44);
    --color-yellow-800: oklch(0.476 0.114 61.91);
    --color-yellow-900: oklch(0.421 0.095 57.71);
    --color-yellow-950: oklch(0.286 0.066 53.81);
    --color-fuchsia-50: oklch(0.977 0.017 320.06);
    --color-violet-50: oklch(0.969 0.016 293.76);
    --color-violet-100: oklch(0.943 0.029 294.59);
    --color-violet-200: oklch(0.894 0.057 293.28);
    --color-violet-300: oklch(0.811 0.111 293.57);
    --color-violet-400: oklch(0.702 0.183 293.54);
    --color-violet-500: oklch(0.606 0.25 292.72);
    --color-violet-600: oklch(0.541 0.281 293.01);
    --color-violet-700: oklch(0.491 0.27 292.58);
    --color-violet-800: oklch(0.432 0.232 292.76);
    --color-violet-900: oklch(0.38 0.189 293.75);
    --color-violet-950: oklch(0.283 0.141 291.09);
    --color-fuchsia-100: oklch(0.952 0.037 318.85);
    --color-fuchsia-200: oklch(0.903 0.076 319.62);
    --color-fuchsia-300: oklch(0.833 0.145 321.43);
    --color-fuchsia-400: oklch(0.74 0.238 322.16);
    --color-fuchsia-500: oklch(0.667 0.295 322.15);
    --color-fuchsia-600: oklch(0.591 0.293 322.9);
    --color-fuchsia-700: oklch(0.518 0.253 323.95);
    --color-fuchsia-800: oklch(0.452 0.211 324.59);
    --color-fuchsia-900: oklch(0.401 0.17 325.61);
    --color-fuchsia-950: oklch(0.293 0.136 325.66);
    --color-red-50: oklch(0.969 0.015 12.42);
    --color-red-100: oklch(0.941 0.03 12.58);
    --color-red-200: oklch(0.892 0.058 10);
    --color-red-300: oklch(0.81 0.117 11.64);
    --color-red-400: oklch(0.712 0.194 13.43);
    --color-red-500: oklch(0.645 0.246 16.44);
    --color-red-600: oklch(0.586 0.253 17.59);
    --color-red-700: oklch(0.514 0.222 16.93);
    --color-red-800: oklch(0.455 0.188 13.7);
    --color-red-900: oklch(0.41 0.159 10.27);
    --color-red-950: oklch(0.271 0.105 12.09);
  }

  :root {
    /* App tokens */
    --color-fg-primary: var(--color-neutral-50);
    --color-bg-primary: var(--color-neutral-950);

    /* Editor chrome */
    --color-cm-background: transparent;
    --color-cm-text: inherit;
    --color-cm-caret: var(--color-neutral-300);
    --color-cm-line-bg: none;
    --color-cm-line-inline-size: auto;
    --color-cm-gutter-fg: var(--color-neutral-600);
    --color-cm-gutter-bg: oklch(var(--color-neutral-950-lch) / 0.7);
    --color-cm-gutter-border: oklch(var(--color-neutral-50-lch) / 0.1);
    --color-cm-active-line-bg: oklch(var(--color-neutral-50-lch) / 0.075);
    --color-cm-active-line-gutter-fg: var(--color-neutral-400);
    --color-cm-active-line-gutter-bg: oklch(
      var(--color-neutral-50-lch) / 0.125
    );
    --color-cm-selection-bg: var(--color-blue-900);
    --color-cm-matching-bracket-bg: var(--color-neutral-700);
    --color-cm-matching-bracket-fg: var(--color-neutral-400);
    --color-cm-nonmatching-bracket-bg: var(--color-red-800);
    --color-cm-nonmatching-bracket-fg: var(--color-red-300);
    --color-cm-selection-match-bg: var(--color-neutral-700);
    --color-cm-selection-match-fg: var(--color-neutral-300);

    /* Syntax highlighting colors */
    --color-cm-keyword: var(--color-violet-400);
    --color-cm-control-keyword: var(--color-violet-400);
    --color-cm-operator: var(--color-neutral-400);
    --color-cm-punctuation: var(--color-neutral-400);
    --color-cm-string: var(--color-green-500);
    --color-cm-number: var(--color-yellow-500);
    --color-cm-bool: var(--color-yellow-500);
    --color-cm-null: var(--color-yellow-500);
    --color-cm-variable: var(--color-neutral-300);
    --color-cm-definition: var(--color-blue-400);
    --color-cm-function: var(--color-blue-400);
    --color-cm-property: var(--color-blue-400);
    --color-cm-comment: var(--color-neutral-600);
    --color-cm-type: var(--color-fuchsia-500);
    --color-cm-class: var(--color-fuchsia-500);
    --color-cm-regexp: var(--color-fuchsia-500);

    /* Evaluation confirmation */
    --color-cm-flash-bg: var(--color-fuchsia-600);
  }

  :root:has(body > #editor-container[data-theme="light"]) {
    /* App tokens */
    --color-fg-primary: var(--color-neutral-950);
    --color-bg-primary: var(--color-neutral-100);

    /* Editor chrome */
    --color-cm-caret: var(--color-neutral-700);
    --color-cm-gutter-fg: var(--color-neutral-400);
    --color-cm-gutter-bg: oklch(var(--color-neutral-50-lch) / 0.7);
    --color-cm-gutter-border: oklch(var(--color-neutral-950-lch) / 0.1);
    --color-cm-active-line-bg: oklch(var(--color-neutral-950-lch) / 0.05);
    --color-cm-active-line-gutter-fg: var(--color-neutral-700);
    --color-cm-active-line-gutter-bg: oklch(var(--color-neutral-950-lch) / 0.1);
    --color-cm-selection-bg: var(--color-blue-200);
    --color-cm-matching-bracket-bg: var(--color-neutral-300);
    --color-cm-matching-bracket-fg: var(--color-neutral-700);
    --color-cm-nonmatching-bracket-bg: var(--color-red-300);
    --color-cm-nonmatching-bracket-fg: var(--color-red-700);
    --color-cm-selection-match-bg: var(--color-neutral-200);
    --color-cm-selection-match-fg: var(--color-neutral-700);

    /* Syntax highlighting colors */
    --color-cm-keyword: var(--color-violet-600);
    --color-cm-control-keyword: var(--color-violet-600);
    --color-cm-operator: var(--color-neutral-600);
    --color-cm-punctuation: var(--color-neutral-600);
    --color-cm-string: var(--color-green-700);
    --color-cm-number: var(--color-yellow-700);
    --color-cm-bool: var(--color-yellow-700);
    --color-cm-null: var(--color-yellow-700);
    --color-cm-variable: var(--color-neutral-500);
    --color-cm-definition: var(--color-blue-600);
    --color-cm-function: var(--color-blue-600);
    --color-cm-property: var(--color-blue-600);
    --color-cm-comment: var(--color-neutral-400);
    --color-cm-type: var(--color-fuchsia-700);
    --color-cm-class: var(--color-fuchsia-700);
    --color-cm-regexp: var(--color-fuchsia-700);

    --color-cm-flash-bg: var(--color-fuchsia-400);
  }

  * {
    box-sizing: border-box;
  }

  html {
    background: var(--color-bg-primary);
    color: var(--color-fg-primary);
  }

  body {
    margin: 0;
  }

  #editor-container {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    height: 100dvh;
  }

  #editor-container[data-flash="true"] {
    --color-cm-line-bg: var(--color-cm-flash-bg);
    --color-cm-active-line-bg: var(--color-cm-flash-bg);
    --color-cm-line-inline-size: fit-content;

    /* Editor chrome */
    --color-cm-selection-bg: transparent;
    --color-cm-matching-bracket-bg: transparent;
    --color-cm-matching-bracket-fg: var(--color-fg-primary);
    --color-cm-nonmatching-bracket-bg: transparent;
    --color-cm-nonmatching-bracket-fg: var(--color-fg-primary);
    --color-cm-selection-match-bg: transparent;
    --color-cm-selection-match-fg: var(--color-fg-primary);

    /* Syntax highlighting colors */
    --color-cm-keyword: var(--color-fg-primary);
    --color-cm-control-keyword: var(--color-fg-primary);
    --color-cm-operator: var(--color-fg-primary);
    --color-cm-punctuation: var(--color-fg-primary);
    --color-cm-string: var(--color-fg-primary);
    --color-cm-number: var(--color-fg-primary);
    --color-cm-bool: var(--color-fg-primary);
    --color-cm-null: var(--color-fg-primary);
    --color-cm-variable: var(--color-fg-primary);
    --color-cm-definition: var(--color-fg-primary);
    --color-cm-function: var(--color-fg-primary);
    --color-cm-property: var(--color-fg-primary);
    --color-cm-comment: var(--color-fg-primary);
    --color-cm-type: var(--color-fg-primary);
    --color-cm-class: var(--color-fg-primary);
    --color-cm-regexp: var(--color-fg-primary);
  }
</style>
